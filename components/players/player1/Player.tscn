[gd_scene load_steps=33 format=2]

[ext_resource path="res://components/players/player1/platform_metroidvania asset pack v1.01/herochar sprites(new)/herochar_idle_anim_strip_4.png" type="Texture" id=1]
[ext_resource path="res://components/players/player1/platform_metroidvania asset pack v1.01/herochar sprites(new)/herochar_jump_up_anim_strip_3.png" type="Texture" id=2]
[ext_resource path="res://components/players/player1/platform_metroidvania asset pack v1.01/herochar sprites(new)/herochar_jump_down_anim_strip_3.png" type="Texture" id=3]
[ext_resource path="res://components/players/player1/platform_metroidvania asset pack v1.01/herochar sprites(new)/herochar_run_anim_strip_6.png" type="Texture" id=4]
[ext_resource path="res://components/players/player1/platform_metroidvania asset pack v1.01/herochar sprites(new)/herochar_death_anim_strip_8.png" type="Texture" id=5]

[sub_resource type="GDScript" id=28]
script/source = "extends Node2D

onready var player:KinematicBody2D = $\".\";
onready var player_animations = $Animations;
onready var player_name_label = $Name
onready var player_collider:CollisionShape2D = $CollisionShape2D;

var player_velocity = Vector2(0, 0);
var fireball_scene = preload(\"res://components/players/player1/Fireball.tscn\")

var fireballs = []

func _ready():	
	player_animations.play(\"idle\")	
	
func _physics_process(delta):	
	if !is_network_master():		
		return
		
	player_velocity.y += 10;

	if !player.is_on_floor() and !player.is_on_wall():
		if player_velocity.y < 0:
			player_animations.play(\"jump\")	
		elif player_velocity.y > 0:
			player_animations.play(\"fall\")
		
	if Input.is_action_pressed(\"ui_left\"):		
		player_animations.flip_h = true
		player_velocity.x -= 5		
		player_animations.play(\"run\")
	elif Input.is_action_pressed(\"ui_right\"):		
		player_animations.flip_h = false
		player_velocity.x += 5
		player_animations.play(\"run\")
	else:
		player_velocity.x = lerp(player_velocity.x, 0, 0.1)
		if player.is_on_floor():
			player_animations.play(\"idle\")
	
	if player.is_on_floor() and Input.is_action_pressed(\"ui_up\"):		
		player_velocity.y -= 250
		player_animations.play(\"jump\")
	elif !player.is_on_floor() and Input.is_action_pressed(\"ui_down\"):
		player_velocity.y += 50
		player_animations.play(\"fall\")
		
	if player.is_on_wall() or player.is_on_ceiling():
		player_velocity.y = 0
		if Input.is_action_pressed(\"ui_up\"):
			player_velocity.y -= 250
			player_animations.play(\"jump\")
		elif Input.is_action_pressed(\"ui_down\"):
			player_velocity.y += 250
			player_animations.play(\"jump\")
			
	player_velocity = player.move_and_slide(player_velocity, Vector2.UP);	
	
	#if player.position != GameState.self_data.position:		
	GameState.self_data.position = player.position
	GameState.self_data.flip_h = player_animations.flip_h;
	GameState.self_data.animation = player_animations.animation
	
	#rpc(\"update_player_data\", GameState.self_data)

	if Input.is_action_just_pressed(\"fire\"):						
		rpc(\"add_fireball_to_world\", player.global_position.x, player.global_position.y, player_animations.flip_h)
		
func death_animation_finished(body):
	#print(\"death_animation_finished\", body.name)
	rpc(\"remove_player_from_world\", int(body.name))	
	body.queue_free()

func fireball_body_entered(body):
	#print(\"fireball_body_entered\", body)
	if body != self:
		if body.is_in_group(\"player\"):
			for child in body.get_children():
				if child is AnimatedSprite:				
					child.play(\"death\")
					if !child.is_connected(\"animation_finished\", self, \"death_animation_finished\"):
						child.connect(\"animation_finished\", self, \"death_animation_finished\", [body])

remotesync func add_fireball_to_world(position_x, position_y, flip_h):
	var player_id = get_tree().get_rpc_sender_id()
	#print(\"add_fireball_to_world\", position_x, flip_h)	
	
	var fireball = fireball_scene.instance()
	var fireball_animations = fireball.get_node(\"AnimatedSprite\");

	if !fireball.is_connected(\"body_entered\", self, \"fireball_body_entered\"):
		fireball.connect(\"body_entered\", self, \"fireball_body_entered\")
	
	fireball.position.x = position_x
	fireball.position.y = position_y
	fireball_animations.flip_h = flip_h
	fireballs.push_front(fireball)
	
	fireball.add_to_group(\"fireball\")
	GameState.add_to_player_group(player_id, fireball)	
	
	get_tree().root.add_child(fireball)	
"

[sub_resource type="AtlasTexture" id=2]
flags = 4
atlas = ExtResource( 1 )
region = Rect2( 0, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=3]
flags = 4
atlas = ExtResource( 1 )
region = Rect2( 16, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=4]
flags = 4
atlas = ExtResource( 1 )
region = Rect2( 32, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=5]
flags = 4
atlas = ExtResource( 1 )
region = Rect2( 48, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=20]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 0, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=21]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 16, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=22]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 32, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=23]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 48, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=24]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 64, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=25]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 80, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=26]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 96, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=27]
flags = 4
atlas = ExtResource( 5 )
region = Rect2( 112, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=6]
flags = 4
atlas = ExtResource( 3 )
region = Rect2( 0, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=7]
flags = 4
atlas = ExtResource( 3 )
region = Rect2( 16, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=8]
flags = 4
atlas = ExtResource( 3 )
region = Rect2( 32, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=9]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 0, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=10]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 16, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=11]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 32, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=12]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 48, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=13]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 64, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=14]
flags = 4
atlas = ExtResource( 4 )
region = Rect2( 80, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=15]
flags = 4
atlas = ExtResource( 2 )
region = Rect2( 0, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=16]
flags = 4
atlas = ExtResource( 2 )
region = Rect2( 16, 0, 16, 16 )

[sub_resource type="AtlasTexture" id=17]
flags = 4
atlas = ExtResource( 2 )
region = Rect2( 32, 0, 16, 16 )

[sub_resource type="SpriteFrames" id=18]
animations = [ {
"frames": [ SubResource( 2 ), SubResource( 3 ), SubResource( 4 ), SubResource( 5 ) ],
"loop": true,
"name": "idle",
"speed": 10.0
}, {
"frames": [ SubResource( 20 ), SubResource( 21 ), SubResource( 22 ), SubResource( 23 ), SubResource( 24 ), SubResource( 25 ), SubResource( 26 ), SubResource( 27 ) ],
"loop": true,
"name": "death",
"speed": 5.0
}, {
"frames": [ SubResource( 6 ), SubResource( 7 ), SubResource( 8 ) ],
"loop": true,
"name": "fall",
"speed": 5.0
}, {
"frames": [ SubResource( 9 ), SubResource( 10 ), SubResource( 11 ), SubResource( 12 ), SubResource( 13 ), SubResource( 14 ) ],
"loop": true,
"name": "run",
"speed": 5.0
}, {
"frames": [ SubResource( 15 ), SubResource( 16 ), SubResource( 17 ) ],
"loop": true,
"name": "jump",
"speed": 5.0
} ]

[sub_resource type="RectangleShape2D" id=19]
extents = Vector2( 6.43067, 7.65998 )

[node name="Player" type="KinematicBody2D" groups=[
"player",
]]
script = SubResource( 28 )

[node name="Name" type="Label" parent="."]
margin_left = -32.0115
margin_top = -21.9489
margin_right = 30.9885
margin_bottom = -7.94888
text = "Name"
align = 1
valign = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Animations" type="AnimatedSprite" parent="."]
frames = SubResource( 18 )
animation = "death"
frame = 5
playing = true

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( -0.353554, 0.30936 )
shape = SubResource( 19 )

[node name="Camera2D" type="Camera2D" parent="."]
